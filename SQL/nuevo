-- 1. Configuraciones iniciales
SET client_encoding = 'UTF8';
SET standard_conforming_strings = 'on';
SELECT pg_catalog.set_config('search_path', '', false);

-- 2. Limpieza (Opcional, si ejecutas desde cero)
DROP TABLE IF EXISTS diagnosticos_ia CASCADE;
DROP TABLE IF EXISTS mediciones CASCADE;
DROP TABLE IF EXISTS alertas CASCADE;
DROP TABLE IF EXISTS sesiones CASCADE;
DROP TABLE IF EXISTS usuarios CASCADE;
DROP TABLE IF EXISTS roles CASCADE;

-- 3. Creación de Tablas
--------------------------------------------------------------------------------
-- Roles
CREATE TABLE public.roles (
    id SERIAL PRIMARY KEY,
    nombre varchar(50) NOT NULL UNIQUE
);

-- Usuarios
CREATE TABLE public.usuarios (
    id SERIAL PRIMARY KEY,
    nombre text NOT NULL,
    apellido text NOT NULL,
    correo text NOT NULL UNIQUE,
    contrasena text NOT NULL, -- Guardará SHA-256
    rol_id integer REFERENCES public.roles(id),
    creado_en timestamp without time zone DEFAULT now(),
    ultimo_acceso timestamp without time zone
);

-- Sesiones
CREATE TABLE public.sesiones (
    id SERIAL PRIMARY KEY,
    usuario_id integer REFERENCES public.usuarios(id) ON DELETE CASCADE,
    fecha_inicio timestamp without time zone DEFAULT now(),
    fecha_fin timestamp without time zone,
    tipo_actividad varchar(20),          -- 'pdf' | 'video'
    fuente varchar(255),                 
    total_segundos integer,
    alertas integer DEFAULT 0,
    kss_final integer,
    es_fatiga boolean,
    resumen jsonb,
    actividades_completadas boolean DEFAULT false
);

-- Mediciones
CREATE TABLE public.mediciones (
    id SERIAL PRIMARY KEY,
    sesion_id integer REFERENCES public.sesiones(id) ON DELETE CASCADE,
    actividad varchar(20),
    perclos numeric(5,2),
    parpadeos integer,
    blink_rate_min numeric(6,2),
    ear_promedio numeric(10,4),
    pct_incompletos numeric(5,2),
    tiempo_cierre numeric(6,2),
    num_bostezos integer,
    velocidad_ocular numeric(10,4),
    nivel_subjetivo integer,
    nivel_fatiga integer,
    estado_fatiga varchar(50),
    max_sin_parpadeo integer,
    alertas integer,
    momentos_fatiga jsonb,
    fecha timestamp without time zone DEFAULT now()
);

-- Alertas
CREATE TABLE public.alertas (
    id SERIAL PRIMARY KEY,
    sesion_id integer REFERENCES public.sesiones(id) ON DELETE CASCADE,
    momento_seg integer,
    motivo text,
    creada_en timestamp without time zone DEFAULT now()
);

-- Diagnósticos IA
CREATE TABLE public.diagnosticos_ia (
    id SERIAL PRIMARY KEY,
    sesion_id integer NOT NULL UNIQUE REFERENCES public.sesiones(id) ON DELETE CASCADE,
    diagnostico_json jsonb NOT NULL,
    fecha_creacion timestamp with time zone DEFAULT CURRENT_TIMESTAMP
);

-- 4. Datos Iniciales y Ajuste de Secuencias
--------------------------------------------------------------------------------
INSERT INTO public.roles (id, nombre) VALUES 
    (1, 'Administrador'), 
    (2, 'Usuario')
ON CONFLICT (id) DO UPDATE SET nombre = EXCLUDED.nombre;

-- Insertar Admin con hash SHA-256 de 'admin123'
INSERT INTO public.usuarios (nombre, apellido, correo, contrasena, rol_id)
VALUES (
    'Admin', 
    'Principal', 
    'admin@admin.com', 
    '240be518ebb21460511d6641b8757d5f352e6d8f5597c649035147a8ed30e07e', -- SHA-256 de 'admin123'
    1
)
ON CONFLICT (correo) DO UPDATE 
SET contrasena = EXCLUDED.contrasena;

-- Actualizar secuencias automáticamente para evitar errores de ID
SELECT setval('public.roles_id_seq', (SELECT MAX(id) FROM public.roles));
SELECT setval('public.usuarios_id_seq', (SELECT MAX(id) FROM public.usuarios));

-- 5. Índices de Rendimiento
--------------------------------------------------------------------------------
CREATE INDEX IF NOT EXISTS idx_sesiones_usuario ON public.sesiones(usuario_id);
CREATE INDEX IF NOT EXISTS idx_mediciones_sesion ON public.mediciones(sesion_id);
CREATE INDEX IF NOT EXISTS idx_alertas_sesion ON public.alertas(sesion_id);
