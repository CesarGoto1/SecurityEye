<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Actividad: Hidrataci√≥n Ocular</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css?v=1.1" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/usuario_main.css?v=1.1">
    <style>
        .focus-circle {
            font-size: 4rem;
            width: 120px;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #eef2f3;
            border-radius: 50%;
            margin: 0 auto 20px auto;
            transition: all 0.3s ease;
        }
        .state-open { border: 4px solid #4CAF50; background: #e8f5e9; }
        .state-close { border: 4px solid #FFC107; background: #fff8e1; transform: scale(0.9); }
        .state-squeeze { border: 4px solid #F44336; background: #ffebee; transform: scale(0.8); }
        .state-finish { border: 4px solid #2196F3; background: #e3f2fd; }
    </style>
</head>
<body id="page-actividad3">

<div class="container d-flex justify-content-center align-items-center min-vh-100">
    <div class="activity-card text-center p-4 shadow rounded bg-white" style="max-width: 600px; width: 100%;">
        <h2 class="mb-4 fw-bold text-primary">Hidrataci√≥n Ocular</h2>
        
        <div class="animation-stage position-relative mb-4">
            <div id="startOverlay" class="start-overlay position-absolute top-0 start-0 w-100 h-100 d-flex flex-column justify-content-center align-items-center" style="background: rgba(255,255,255,0.95); z-index: 10;">
                <p style="color:#666; margin-bottom: 20px;">Sigue las instrucciones de voz</p>
                <button class="btn btn-primary btn-lg fw-bold" onclick="startActivity()">Empezar Terapia</button>
            </div>
            
            <div class="py-5">
                <div class="focus-circle state-open" id="focusCircle">üëÅÔ∏è</div>
            </div>
        </div>

        <div class="instruction-container mb-4">
            <div class="instruction-text fs-3 fw-bold mb-2" id="dynamicText">Rel√°jate</div>
            <div class="sub-text text-muted" id="subText">Activa el audio para escuchar la gu√≠a</div>
        </div>

        <div class="progress-wrapper" id="progressContainer" style="display: none;">
            <div class="progress mb-2" style="height: 25px;">
                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
            </div>
            <div class="timer-text text-muted">Repeticiones: <span id="repCount" class="fw-bold text-dark">0</span> / 5</div>
        </div>

        <button id="finishBtn" class="btn btn-primary btn-lg mt-3" onclick="finishActivity()" style="display:none;">Terminar Sesi√≥n <i class="bi bi-check-circle"></i></button>
    </div>
</div>

<script>
    // --- CONFIGURACI√ìN ---
    const REPETICIONES_META = 5;
    const TIEMPO_CIERRE = 3000;  // 3 seg cerrando suave
    const TIEMPO_SQUEEZE = 2000; // 2 seg apretando fuerte
    const TIEMPO_RELAX = 3000;   // 3 seg relajando

    // Elementos
    const startOverlay = document.getElementById('startOverlay');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const repCountDisplay = document.getElementById('repCount');
    const finishBtn = document.getElementById('finishBtn');
    const circle = document.getElementById('focusCircle');
    const dynamicText = document.getElementById('dynamicText');
    const subText = document.getElementById('subText');

    let repeticiones = 0;
    let synth = window.speechSynthesis;

    function startActivity() {
        // UI Setup
        startOverlay.style.opacity = '0';
        setTimeout(() => startOverlay.style.display = 'none', 400);
        progressContainer.style.display = 'block';
        
        // Iniciar el ciclo
        ejecutarCiclo();
    }

    function ejecutarCiclo() {
        if (repeticiones >= REPETICIONES_META) {
            completarActividad();
            return;
        }

        // PASO 1: CERRAR SUAVE
        actualizarUI("Cierra Suavemente", "Cierra los ojos sin apretar", "state-close", "üòå");
        hablar("Cierra los ojos suavemente");

        setTimeout(() => {
            // PASO 2: APRETAR (SQUEEZE)
            actualizarUI("¬°APRIETA!", "Aprieta los p√°rpados fuerte", "state-squeeze", "üò£");
            hablar("Aprieta fuerte, ahora");
            
            setTimeout(() => {
                // PASO 3: RELAJAR
                repeticiones++;
                actualizarProgreso();
                actualizarUI("Abre y Relaja", "Parpadea normalmente", "state-open", "‚ú®");
                hablar("Abre y relaja");

                // Esperar antes del siguiente ciclo
                if (repeticiones < REPETICIONES_META) {
                    setTimeout(ejecutarCiclo, TIEMPO_RELAX);
                } else {
                    setTimeout(completarActividad, TIEMPO_RELAX);
                }

            }, TIEMPO_SQUEEZE); 

        }, TIEMPO_CIERRE); 
    }

    function actualizarUI(titulo, subtitulo, claseCirculo, icono) {
        dynamicText.innerText = titulo;
        subText.innerText = subtitulo;
        circle.className = `focus-circle ${claseCirculo}`;
        circle.innerText = icono;
    }

    function actualizarProgreso() {
        repCountDisplay.innerText = repeticiones;
        const porcentaje = (repeticiones / REPETICIONES_META) * 100;
        progressBar.style.width = porcentaje + "%";
    }

    function completarActividad() {
        actualizarUI("¬°Completado!", "Tus ojos est√°n hidratados", "state-finish", "üéâ");
        hablar("Excelente trabajo. Ejercicio completado.");
        
        progressBar.classList.remove('progress-bar-animated');
        progressBar.classList.add('bg-success');
        finishBtn.style.display = 'inline-block';
    }

    function hablar(texto) {
        if (synth.speaking) synth.cancel();
        const utterance = new SpeechSynthesisUtterance(texto);
        utterance.lang = 'es-ES';
        utterance.rate = 1.0; 
        synth.speak(utterance);
    }

    function finishActivity() {
        // Redirige de vuelta a la p√°gina de monitoreo, pasando los par√°metros de la sesi√≥n.
        const params = new URLSearchParams(window.location.search);
        const sesionId = params.get('sesion_id');
        const tipo = params.get('tipo');
        const nombre = params.get('nombre');
        const url = params.get('url');

        const nextParams = new URLSearchParams();
        if (sesionId) nextParams.append('sesion_id', sesionId);
        if (tipo) nextParams.append('tipo', tipo);
        if (nombre) nextParams.append('nombre', nombre);
        if (url) nextParams.append('url', url);

        const nextUrl = `/usuario/monitoreo.html?${nextParams.toString()}`;
        window.location.href = nextUrl;
    }
</script>

</body>
</html>