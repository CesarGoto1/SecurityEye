<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Actividad: Loop Infinito</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/usuario_main.css">
</head>
<body>

<div class="container d-flex justify-content-center align-items-center min-vh-100">
    <div class="activity-card text-center p-4 shadow rounded bg-white" style="max-width: 900px; width: 100%;">
        <h2 class="mb-4 fw-bold text-primary">Loop Infinito</h2>

        <div class="canvas-container position-relative mb-4" style="margin: 0 auto;">
            <canvas id="activityCanvas" width="800" height="400" style="max-width: 100%; height: auto; border: 1px solid #f0f0f0; border-radius: 8px;"></canvas>
            
            <div id="startLabel" class="start-marker position-absolute" style="top: 50%; left: 50%; transform: translate(-50%, -50%);">
                <div style="background:white; padding:2px 8px; border-radius:4px; border:1px solid #ccc; font-weight: bold;">Inicio</div>
                <div style="text-align:center; color:#e74c3c;">▼</div>
            </div>

            <div id="startOverlay" class="start-overlay position-absolute top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center" style="background: rgba(255,255,255,0.9); z-index: 10;">
                <button class="btn btn-primary btn-lg px-5 py-3 fw-bold" onclick="startActivity()">Empezar Actividad</button>
            </div>
        </div>

        <div class="progress-wrapper mb-3" id="progressContainer" style="display:none;">
            <div class="progress mb-2" style="height: 25px;">
                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
            </div>
            <div class="timer-text text-muted">Tiempo restante: <span id="timerCount" class="fw-bold text-dark">30</span>s</div>
        </div>

        <button id="finishBtn" class="btn btn-success btn-lg mt-3" onclick="finishActivity()" style="display:none;">Siguiente Actividad <i class="bi bi-arrow-right"></i></button>
    </div>
</div>

<script>
    // ==========================================
    // CONFIGURACIÓN
    // ==========================================
    const DURATION_SECONDS = 30; 
    const BALL_SPEED = 0.02; 

    // Referencias DOM
    const canvas = document.getElementById('activityCanvas');
    const ctx = canvas.getContext('2d');
    const startOverlay = document.getElementById('startOverlay');
    const startLabel = document.getElementById('startLabel');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const timerCount = document.getElementById('timerCount');
    const finishBtn = document.getElementById('finishBtn');

    // Variables de Estado
    let isRunning = false;
    let angle = 0; 
    let animationId;
    let timeLeft = DURATION_SECONDS;
    let timerInterval;

    // Dimensiones
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const widthRadius = 300; 
    const heightRadius = 100; 

    // 1. Dibujar el Riel
    function drawTrack() {
        ctx.beginPath();
        ctx.lineWidth = 15; 
        ctx.strokeStyle = '#e0e0e0'; 
        ctx.lineCap = 'round';
        
        // Curva de Lissajous (Figura 8)
        for (let t = 0; t <= Math.PI * 2; t += 0.01) {
            const x = centerX + widthRadius * Math.cos(t);
            const y = centerY + heightRadius * Math.sin(2 * t);
            if (t === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
        }
        ctx.stroke();
    }

    // 2. Dibujar la Bola
    function drawBall(x, y) {
        // Sombra
        ctx.beginPath();
        ctx.arc(x, y + 8, 18, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(0,0,0,0.1)';
        ctx.fill();

        // Bola
        ctx.beginPath();
        ctx.arc(x, y, 18, 0, Math.PI * 2);
        ctx.fillStyle = '#3A7D8E'; 
        ctx.fill();
        
        // Brillo
        ctx.beginPath();
        ctx.arc(x - 6, y - 6, 6, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(255,255,255,0.4)';
        ctx.fill();
    }

    // 3. Loop de Animación
    function update() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawTrack();

        const x = centerX + widthRadius * Math.cos(angle);
        const y = centerY + heightRadius * Math.sin(2 * angle);

        drawBall(x, y);

        if (isRunning) {
            angle += BALL_SPEED;
            if(angle > Math.PI * 2) angle -= Math.PI * 2;
            animationId = requestAnimationFrame(update);
        }
    }

    // 4. Lógica del Timer
    function runTimer() {
        const totalTime = DURATION_SECONDS;
        
        timerInterval = setInterval(() => {
            timeLeft--;
            timerCount.textContent = timeLeft;
            
            const percentage = ((totalTime - timeLeft) / totalTime) * 100;
            progressBar.style.width = percentage + "%";

            if (timeLeft <= 0) {
                completeActivity();
            }
        }, 1000);
    }

    function startActivity() {
        isRunning = true;
        startOverlay.style.opacity = '0';
        setTimeout(() => startOverlay.style.display = 'none', 500);
        startLabel.style.display = 'none';
        progressContainer.style.display = 'block';
        
        update();
        runTimer();
    }

    function completeActivity() {
        isRunning = false;
        cancelAnimationFrame(animationId);
        clearInterval(timerInterval);
        
        progressBar.classList.remove('progress-bar-animated');
        progressBar.classList.add('bg-success');
        timerCount.textContent = "0 (Completado)";
        
        finishBtn.style.display = 'inline-block';
    }

    function finishActivity() {
        // Preservar sesion_id
        const params = new URLSearchParams(window.location.search);
        const sesionId = params.get('sesion_id');
        const nextUrl = sesionId ? `instruccion2.html?sesion_id=${sesionId}` : 'instruccion2.html';
        window.location.href = nextUrl; 
    }

    // Inicialización
    drawTrack();
    drawBall(centerX + widthRadius, centerY);

</script>
</body>
</html>