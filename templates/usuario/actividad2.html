<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Actividad: Enfoque Profundo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css?v=1.1" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/usuario_main.css?v=1.1">
    <style>
        /* Estilos específicos para la animación de respiración */
        .animation-stage {
            position: relative;
            height: 300px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .focus-circle {
            width: 80px;
            height: 80px;
            background-color: #3A7D8E;
            border-radius: 50%;
            transition: transform 0.1s linear;
        }
        .animating {
            animation: breathe 8s infinite ease-in-out;
        }
        @keyframes breathe {
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(3); opacity: 0.4; } /* Inhala (Grande) */
            100% { transform: scale(1); opacity: 0.8; } /* Exhala (Pequeño) */
        }
        .guide-dot {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #ccc;
            border-radius: 50%;
        }
        .g-left { left: 20px; }
        .g-right { right: 20px; }
        .instruction-text {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
            transition: color 0.5s;
        }
    </style>
</head>
<body id="page-actividad2">

<div class="container d-flex justify-content-center align-items-center min-vh-100">
    <div class="activity-card text-center p-4 shadow rounded bg-white" style="max-width: 600px; width: 100%;">
        <h2 class="mb-4 fw-bold text-primary">Enfoque y Respiración</h2>
        
        <div class="animation-stage">
            <div id="startOverlay" class="start-overlay position-absolute w-100 h-100 d-flex justify-content-center align-items-center" style="background: rgba(255,255,255,0.95); z-index: 10;">
                <button class="btn btn-primary btn-lg fw-bold" onclick="startActivity()">Empezar Actividad</button>
            </div>
            <div class="guide-dot g-left"></div>
            <div class="guide-dot g-right"></div>
            <div class="focus-circle" id="focusCircle"></div>
        </div>

        <div class="instruction-container mb-4" style="min-height: 60px;">
            <div class="instruction-text" id="dynamicText" style="opacity: 0.5;">Prepárate</div>
        </div>

        <div class="progress-wrapper" id="progressContainer" style="display: none;">
            <div class="progress mb-2" style="height: 25px;">
                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
            </div>
            <div class="timer-text text-muted">Tiempo restante: <span id="timerCount" class="fw-bold text-dark">64</span>s</div>
        </div>

        <button id="finishBtn" class="btn btn-success btn-lg mt-3" onclick="finishActivity()" style="display:none;">Siguiente Actividad <i class="bi bi-arrow-right"></i></button>
    </div>
</div>

<script>
    const CYCLE_DURATION = 8000;
    const TOTAL_DURATION = 64;

    const startOverlay = document.getElementById('startOverlay');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const timerCount = document.getElementById('timerCount');
    const finishBtn = document.getElementById('finishBtn');
    const circle = document.getElementById('focusCircle');
    const dynamicText = document.getElementById('dynamicText');

    let timeLeft = TOTAL_DURATION;
    let timerInterval;
    let textInterval;

    function startActivity() {
        startOverlay.style.opacity = '0';
        setTimeout(() => startOverlay.style.display = 'none', 400);
        progressContainer.style.display = 'block';
        dynamicText.style.opacity = '1';
        
        circle.classList.add('animating');

        runTextCycle(); 
        textInterval = setInterval(runTextCycle, CYCLE_DURATION);
        runTimer();
    }

    function runTextCycle() {
        // Fase 1: INHALA (4 segundos)
        dynamicText.textContent = "Inhala... (Enfoca Lejos)";
        dynamicText.style.color = "#2a5d6b"; 

        // Fase 2: EXHALA (4 segundos)
        setTimeout(() => {
            if(timeLeft > 0) {
                dynamicText.textContent = "Exhala... (Enfoca Cerca)";
                dynamicText.style.color = "#3A7D8E";
            }
        }, 4000);
    }

    function runTimer() {
        timerInterval = setInterval(() => {
            timeLeft--;
            timerCount.textContent = timeLeft;
            
            const percentage = ((TOTAL_DURATION - timeLeft) / TOTAL_DURATION) * 100;
            progressBar.style.width = percentage + "%";

            if (timeLeft <= 0) {
                completeActivity();
            }
        }, 1000);
    }

    function completeActivity() {
        clearInterval(timerInterval);
        clearInterval(textInterval);
        circle.classList.remove('animating');
        
        dynamicText.textContent = "¡Completado!";
        circle.style.transform = "scale(1)";
        
        progressBar.classList.remove('progress-bar-animated');
        progressBar.classList.add('bg-success');
        
        timerCount.textContent = "0 (Completado)";
        finishBtn.style.display = 'inline-block';
    }

    function finishActivity() {
        // Redirige de vuelta a la página de monitoreo, pasando los parámetros de la sesión.
        const params = new URLSearchParams(window.location.search);
        const sesionId = params.get('sesion_id');
        const tipo = params.get('tipo');
        const nombre = params.get('nombre');
        const url = params.get('url');

        const nextParams = new URLSearchParams();
        if (sesionId) nextParams.append('sesion_id', sesionId);
        if (tipo) nextParams.append('tipo', tipo);
        if (nombre) nextParams.append('nombre', nombre);
        if (url) nextParams.append('url', url);

        const nextUrl = `/usuario/monitoreo.html?${nextParams.toString()}`;
        window.location.href = nextUrl;
    }
</script>

</body>
</html>